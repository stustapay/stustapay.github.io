"use strict";(self.webpackChunkwebsite=self.webpackChunkwebsite||[]).push([[5131],{3905:(e,t,n)=>{n.d(t,{Zo:()=>p,kt:()=>h});var a=n(7294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function o(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?i(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},i=Object.keys(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var l=a.createContext({}),u=function(e){var t=a.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):o(o({},t),e)),n},p=function(e){var t=u(e.components);return a.createElement(l.Provider,{value:t},e.children)},c="mdxType",d={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},m=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,i=e.originalType,l=e.parentName,p=s(e,["components","mdxType","originalType","parentName"]),c=u(n),m=r,h=c["".concat(l,".").concat(m)]||c[m]||d[m]||i;return n?a.createElement(h,o(o({ref:t},p),{},{components:n})):a.createElement(h,o({ref:t},p))}));function h(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var i=n.length,o=new Array(i);o[0]=m;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s[c]="string"==typeof e?e:r,o[1]=s;for(var u=2;u<i;u++)o[u]=n[u];return a.createElement.apply(null,o)}return a.createElement.apply(null,n)}m.displayName="MDXCreateElement"},3558:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>o,default:()=>d,frontMatter:()=>i,metadata:()=>s,toc:()=>u});var a=n(7462),r=(n(7294),n(3905));const i={},o="NFC Tag Production",s={unversionedId:"user-guide/nfctags",id:"user-guide/nfctags",title:"NFC Tag Production",description:"StuStaPay supports the following NFC tags:",source:"@site/docs/user-guide/nfctags.md",sourceDirName:"user-guide",slug:"/user-guide/nfctags",permalink:"/docs/user-guide/nfctags",draft:!1,editUrl:"https://github.com/stustapay/stustapay/tree/master/website/docs/user-guide/nfctags.md",tags:[],version:"current",frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"App",permalink:"/docs/user-guide/app"},next:{title:"Administrator Documentation",permalink:"/docs/administrator-documentation/"}},l={},u=[{value:"Secret Keys",id:"secret-keys",level:2},{value:"Per-Token Secrets",id:"per-token-secrets",level:2},{value:"Laser",id:"laser",level:2},{value:"Feedback from Manufacturer",id:"feedback-from-manufacturer",level:2},{value:"Chip Programming",id:"chip-programming",level:2},{value:"MIFARE Ultralight AES MF0AES(H)20",id:"mifare-ultralight-aes-mf0aesh20",level:3},{value:"Programming MF0AES(H)20 with CMAC communication",id:"programming-mf0aesh20-with-cmac-communication",level:4},{value:"Testing",id:"testing",level:2}],p={toc:u},c="wrapper";function d(e){let{components:t,...n}=e;return(0,r.kt)(c,(0,a.Z)({},p,n,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("h1",{id:"nfc-tag-production"},"NFC Tag Production"),(0,r.kt)("p",null,"StuStaPay supports the following NFC tags:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"MIFARE Ultralight AES (",(0,r.kt)("inlineCode",{parentName:"li"},"MF0AES(H)20"),")")),(0,r.kt)("p",null,"You can either program them using the StuStaPay Android App, or if you need larger quantities, find a supplier who can do the programming and id-lasering for you."),(0,r.kt)("h2",{id:"secret-keys"},"Secret Keys"),(0,r.kt)("p",null,"There are two secret keys (the same for all chips)."),(0,r.kt)("p",null,"To generate those keys:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"python3 -m stustapay -c <your-config>.yaml token generate-key\n")),(0,r.kt)("p",null,"This yields you the generated keys as output:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-markdown"},"Secret keys:\n\nkey0 = <16 bytes from `openssl rand -hex 16`>\nkey1 = <16 different bytes for key1>\n\nSo:\n- key0[0]: <for clarification, the first first byte of key0>\n- key0[15]: <key0 last byte>\n- key1[0]: <key1 first byte>\n- key1[15]: <key1 last byte>\n")),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"key0")," and ",(0,r.kt)("inlineCode",{parentName:"p"},"key1")," are then used during programming.\nThe file also describes the concrete bytes used in programming below (",(0,r.kt)("inlineCode",{parentName:"p"},"key0[0]"),", ",(0,r.kt)("inlineCode",{parentName:"p"},"key1[0]"),", ...).\nThe last lines are there so the byte order isn't swapped accidentially."),(0,r.kt)("h2",{id:"per-token-secrets"},"Per-Token Secrets"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"python3 -m stustapay -c <your-config>.yaml token generate-nfc --count <number>\n")),(0,r.kt)("p",null,"This yields a list of ",(0,r.kt)("inlineCode",{parentName:"p"},"<number>")," individual secrets, for example:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"index,id,pin\n0,40cf0dd3411aa7d3,GKBQDP\n1,76c90aebcf54d989,R71J6Y\n...\n")),(0,r.kt)("p",null,"This output should be supplied via a csv file to the NFC chip manufacturer.\nSo we provide for each chip:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"individual 8 byte random ",(0,r.kt)("inlineCode",{parentName:"li"},"id")," (stored in chip memory)"),(0,r.kt)("li",{parentName:"ul"},"individual 6 character ",(0,r.kt)("inlineCode",{parentName:"li"},"PIN")," for lasering on the NFC tag")),(0,r.kt)("p",null,"The chip manufacturer then has to supply you each chips NFC ",(0,r.kt)("inlineCode",{parentName:"p"},"UID")," assigned to the ",(0,r.kt)("inlineCode",{parentName:"p"},"index"),"/",(0,r.kt)("inlineCode",{parentName:"p"},"id"),"/",(0,r.kt)("inlineCode",{parentName:"p"},"pin")," during manufacturing, because only they know what Chip they assigned to our generated IDs/PINs."),(0,r.kt)("h2",{id:"laser"},"Laser"),(0,r.kt)("p",null,"On the back of the chip, you can let your manufacturer engrave your payment event website url, and the UID & PIN. Users can use this website to TopUp and see their status by logging in with the ",(0,r.kt)("inlineCode",{parentName:"p"},"UID")," and ",(0,r.kt)("inlineCode",{parentName:"p"},"PIN")," they see on the back of their NFC chip."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"pay.your-stustapay-event-name.de\n<<chip's UID in uppercase>>\n<<chip's individual pin from csv file>>\n")),(0,r.kt)("p",null,"and additionally, if possible, either a datamatrix or qr-code with this url: ",(0,r.kt)("a",{parentName:"p",href:"https://pay.your-stustapay-event-name.de"},"https://pay.your-stustapay-event-name.de")),(0,r.kt)("h2",{id:"feedback-from-manufacturer"},"Feedback from Manufacturer"),(0,r.kt)("p",null,"As a result from the manufacturer, you'll need a CSV or Excel file associating all information for each chip:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"chip's ",(0,r.kt)("inlineCode",{parentName:"li"},"uid")," (given by hardware)"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"custom id")," from our csv file"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"pin")," from our csv file")),(0,r.kt)("p",null,"This is needed so StuStaPay can assign the hardware UID with our generated PIN/ID."),(0,r.kt)("h2",{id:"chip-programming"},"Chip Programming"),(0,r.kt)("p",null,"Depending on the Chip type the data needs to be flashed into each NFC tag."),(0,r.kt)("h3",{id:"mifare-ultralight-aes-mf0aesh20"},"MIFARE Ultralight AES MF0AES(H)20"),(0,r.kt)("p",null,"This is the programming description for MIFARE's ",(0,r.kt)("inlineCode",{parentName:"p"},"MF0AES(H)20")," chip."),(0,r.kt)("p",null,"To program each chip we need to write a custom message, an ",(0,r.kt)("strong",{parentName:"p"},"individual chip id"),", and the ",(0,r.kt)("strong",{parentName:"p"},"two keys"),"."),(0,r.kt)("p",null,"The short custom message can be customized to whatever your users will read out when scanning their Chip with a smartphone - be creative :) The message is not write-protected intentionally, so user's can update the message to something they like! Other parts of the chip are of course write protected."),(0,r.kt)("p",null,"These are the necessary chip programming commands (for more info, see the ",(0,r.kt)("inlineCode",{parentName:"p"},"MF0AES(H)20")," data sheet):"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-plain"},"Write a short custom message (that can be changed by curious event visitors intentionally):\n\na2 04 'S' 't' 'u' 'S'\na2 05 't' 'a' 'P' 'a'\na2 06 'y' ' ' '-' ' '\na2 07 'h' 'a' 'v' 'e'\na2 08 'f' 'u' 'n' '!'\na2 09 '\\n' 00 00  00\na2 0a 00  00  00  00\na2 0b 00  00  00  00\na2 0c 00  00  00  00\na2 0d 00  00  00  00\na2 0e 00  00  00  00\na2 0f 00  00  00  00\n\nWrite custom individual chip id from (the `id` column from the generated PIN list):\n\na2 10 id[7] id[6] id[5] id[4]\na2 11 id[3] id[2] id[1] id[0]\n\n\nWrite key (key0 from the secrets):\n\na2 30 key0[15] key0[14] key0[13] key0[12]\na2 31 key0[11] key0[10] key0[9] key0[8]\na2 32 key0[7] key0[6] key0[5] key0[4]\na2 33 key0[3] key0[2] key0[1] key0[0]\n\n\nWrite backup key (key1 from the secrets):\n\na2 34 key1[15] key1[14] key1[13] key1[12]\na2 35 key1[11] key1[10] key1[9] key1[8]\na2 36 key1[7] key1[6] key1[5] key1[4]\na2 37 key1[3] key1[2] key1[1] key1[0]\n\n\nNow the programming system has to go into AUTHENTICATED state using key0:\n\n<<AUTHENTICATE with key0>>\n\n\nWrite Configuration:\n\na2 28 01 00 00 00 (lock pages 0x10 and 0x11)\na2 2d e0 00 00 00 (lock keys, lock key lock)\na2 2a 80 05 00 00 (disable reading without auth,\n                   disable access to counter without auth,\n                   set virtual card id to 0x05,\n                   disable failed auth limit)\na2 29 02 00 00 10 (enable cmac, disable random id, protect from page 0x10 onwards)\n")),(0,r.kt)("p",null,"That's it, the production test should now be quite happy!"),(0,r.kt)("h4",{id:"programming-mf0aesh20-with-cmac-communication"},"Programming MF0AES(H)20 with CMAC communication"),(0,r.kt)("p",null,"This is an alternative programming scheme that starts just after ",(0,r.kt)("inlineCode",{parentName:"p"},"<<AUTHENTICATED>>")," in the above commands."),(0,r.kt)("p",null,'Once CMAC is activated, all communication messages to the have to be "signed".\nSince a manufacturer\'s assembly line most likely does not support CMAC yet, this variant is likely to work in the future only - these programming instructions just have a swapped order for when to enable CMAC.'),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"[... write keys, authenticate]\n\nWrite Configuration (if your assembly line supports CMAC):\n\na2 28 01 00 00 00 (lock pages 0x10 and 0x11)\na2 29 02 00 00 10 (enable cmac, disable random id, protect from page 0x10 onwards)\n\n<Enable CMAC communication for the following NFC commands>\n\na2 2d e0 00 00 00 (lock keys, lock key lock)\na2 2a c0 05 00 00 (disable reading without auth,\n                   lock config,\n                   disable access to counter without auth,\n                   set virtual card id to 0x05,\n                   disable failed auth limit)\n")),(0,r.kt)("h2",{id:"testing"},"Testing"),(0,r.kt)("p",null,"After configuring the secret keys in StuStaPay, you should be able to read and validate a correctly-programmed NFC tag."),(0,r.kt)("p",null,"The StuStaPay App supports running a NFC tag production test which you can send to the manufacturer so they can validate the correct programming on-site before shipping the tags to you."))}d.isMDXComponent=!0}}]);